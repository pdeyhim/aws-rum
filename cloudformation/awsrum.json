{"Mappings":{"AWSInstanceType2Arch":{"t1.micro":{"Arch":"64"},"m1.small":{"Arch":"64"},"m1.medium":{"Arch":"64"},"m1.large":{"Arch":"64"},"m1.xlarge":{"Arch":"64"},"m2.xlarge":{"Arch":"64"},"m2.2xlarge":{"Arch":"64"},"m2.4xlarge":{"Arch":"64"},"m3.xlarge":{"Arch":"64"},"m3.2xlarge":{"Arch":"64"},"c1.medium":{"Arch":"64"},"c1.xlarge":{"Arch":"64"},"m3.large":{"Arch":"64"}},"AWSRegionArch2AMI":{"us-east-1":{"64":"ami-89e4e4e0"}},"SubnetConfig":{"VPC":{"CIDR":"10.0.0.0/16"},"Public1":{"CIDR":"10.0.1.0/24"},"Public2":{"CIDR":"10.0.2.0/24"},"Public3":{"CIDR":"10.0.3.0/24"}}},"Parameters":{"DynamoDBRangeKey":{"Description":"DynamoDB range key","Type":"String","Default":"mtime"},"KinesisStreamName":{"Description":"Name of the Kinesis stream","Type":"String","Default":"myLargeStream"},"KeyName":{"Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances","Type":"String","MinLength":"1","MaxLength":"64","AllowedPattern":"[-_ a-zA-Z0-9]*","Default":"accesskey1","ConstraintDescription":"can contain only alphanumeric characters, spaces, dashes and underscores."},"RedshiftClusterName":{"Description":"Name of the Redshift cluster","Type":"String","Default":"awsrum"},"RedshiftDatabaseName":{"Description":"Redshift Database name","Type":"String","Default":"awsrumdb"},"RedshiftTable":{"Description":"Redshift data table name","Type":"String","Default":"awsrumtable"},"RedshiftUsername":{"Description":"Redshift username","Type":"String","Default":"awsrum"},"RedshiftPassword":{"Description":"Redshift password","Type":"String","Default":"Sepas!23456"},"RedshiftNodeType":{"Description":"Redshift node type","Type":"String","Default":"dw2.large"},"RedshiftDataDelimiter":{"Description":"Redshift tale delimiter","Type":"String","Default":","},"RedshiftBufferSizeLimit":{"Description":"how much data to buffer before copy to Redshift","Type":"Number","Default":1000000},"KinesisNumberOfShards":{"Description":"Number of shards for the Kinesis stream","Type":"Number","Default":"1"},"DynamoDBDataTableName":{"Description":"DynamoDB table name","Type":"String","Default":"awsrumtable"},"DynamoDBKey":{"Description":"DynamoDB Hash key","Type":"String","Default":"uuid"},"DynamoDBReadCapacityUnits":{"Description":"DynamoDB read capacity","Type":"String","Default":"1"},"DynamoDBWriteCapacityUnits":{"Description":"DynamoDB write capacity","Type":"String","Default":"20"},"DynamoDBBufferSizeLimit":{"Description":"collector data buffer size","Type":"Number","Default":"1000000"},"RedshiftNumberOfNodes":{"Description":"Redshift number of nodes","Type":"Number","Default":2},"DynamoDBCollectorInstanceType":{"Description":"DynamoDB collector instance type","Type":"String","Default":"m3.large"},"DynamoDBCollectorNumberOfNodes":{"Description":"Redshift node type","Type":"Number","Default":1},"SSHLocation":{"Description":"SSH src location","Type":"String","Default":"0.0.0.0/0"},"RedshiftCollectorInstanceType":{"Description":"Redshift collector instance type","Type":"String","Default":"m3.large"},"RedshiftCollectorNumberOfNodes":{"Description":"Redshift collector number of nodes","Type":"Number","Default":1},"DynamoDBBufferRecordLimit":{"Description":"collector data buffer size","Type":"Number","Default":"100"},"RedshiftS3Bucket":{"Description":"Redshift S3 bucket staging","Type":"String","Default":"parvizkinesis"},"RedshiftBufferRecordLimit":{"Description":"how many records to buffer before copy to Redshift","Type":"Number","Default":1000},"RedshiftURL":{"Description":"Redshift Cluster URL","Type":"String","Default":"jdbc:postgresql://kinesiscluster.cinbgjxflxxk.us-east-1.redshift.amazonaws.com:5439/kinesisdatabase?tcpKeepAlive=true\t"},"JsonSchemaBucket":{"Description":"Data schema json bucket","Type":"String","Default":"awsrum"},"JsonSchemaKey":{"Description":"Data schema json S3 key","Type":"String","Default":"schema\\/schema.json"},"DataSchemaVersion":{"Description":"update this version everytime you change your data schema","Type":"Number","Default":"1"},"AZ1":{"Description":"1st AZ","Type":"String","Default":"us-east-1a"},"AZ2":{"Description":"2nd AZ","Type":"String","Default":"us-east-1b"},"AZ3":{"Description":"3rd AZ","Type":"String","Default":"us-east-1c"}},"Resources":{"VPC":{"Type":"AWS::EC2::VPC","Properties":{"CidrBlock":{"Fn::FindInMap":["SubnetConfig","VPC","CIDR"]},"EnableDnsSupport":"true","EnableDnsHostnames":"true","Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public"},{"Key":"Name","Value":"AWSRUM"}]}},"PublicSubnet1":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::FindInMap":["SubnetConfig","Public1","CIDR"]},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public1"},{"Key":"Name","Value":"AWSRUM"}],"AvailabilityZone":{"Ref":"AZ1"}}},"PublicSubnet2":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::FindInMap":["SubnetConfig","Public2","CIDR"]},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public2"}],"AvailabilityZone":{"Ref":"AZ2"}}},"PublicSubnet3":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::FindInMap":["SubnetConfig","Public3","CIDR"]},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public3"},{"Key":"Name","Value":"AWSRUM"}],"AvailabilityZone":{"Ref":"AZ3"}}},"InternetGateway":{"Type":"AWS::EC2::InternetGateway","Properties":{"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public"},{"Key":"Name","Value":"AWSRUM"}]}},"GatewayToInternet":{"Type":"AWS::EC2::VPCGatewayAttachment","Properties":{"VpcId":{"Ref":"VPC"},"InternetGatewayId":{"Ref":"InternetGateway"}}},"PublicRouteTable":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}},{"Key":"Network","Value":"Public"},{"Key":"Name","Value":"AWSRUM"}]}},"PublicRoute":{"Type":"AWS::EC2::Route","DependsOn":"GatewayToInternet","Properties":{"RouteTableId":{"Ref":"PublicRouteTable"},"DestinationCidrBlock":"0.0.0.0/0","GatewayId":{"Ref":"InternetGateway"}}},"Public1SubnetRouteTableAssociation":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"PublicSubnet1"},"RouteTableId":{"Ref":"PublicRouteTable"}}},"Public3SubnetRouteTableAssociation":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"PublicSubnet3"},"RouteTableId":{"Ref":"PublicRouteTable"}}},"DynamoDBCollectorASG":{"Type":"AWS::AutoScaling::AutoScalingGroup","Properties":{"AvailabilityZones":[{"Fn::GetAtt":["PublicSubnet1","AvailabilityZone"]},{"Fn::GetAtt":["PublicSubnet2","AvailabilityZone"]},{"Fn::GetAtt":["PublicSubnet3","AvailabilityZone"]}],"VPCZoneIdentifier":[{"Ref":"PublicSubnet1"},{"Ref":"PublicSubnet2"},{"Ref":"PublicSubnet3"}],"LaunchConfigurationName":{"Ref":"DynamoDBCollectorLaunchConfig"},"MinSize":"1","MaxSize":"10","DesiredCapacity":{"Ref":"DynamoDBCollectorNumberOfNodes"},"Tags":[{"Key":"Network","Value":"Public","PropagateAtLaunch":"true"},{"Key":"Name","Value":"DynamoDBCollector","PropagateAtLaunch":"true"}]},"UpdatePolicy":{"AutoScalingRollingUpdate":{"MinInstancesInService":"1","MaxBatchSize":"1"}}},"DynamoDBCollectorLaunchConfig":{"Type":"AWS::AutoScaling::LaunchConfiguration","Properties":{"ImageId":{"Fn::FindInMap":["AWSRegionArch2AMI",{"Ref":"AWS::Region"},{"Fn::FindInMap":["AWSInstanceType2Arch",{"Ref":"DynamoDBCollectorInstanceType"},"Arch"]}]},"SecurityGroups":[{"Ref":"AWSRumSG"}],"InstanceType":{"Ref":"DynamoDBCollectorInstanceType"},"KeyName":{"Ref":"KeyName"},"AssociatePublicIpAddress":"true","IamInstanceProfile":{"Ref":"DynamoDBCollectorInstanceProfile"},"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -ex\n","exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n","apt-get -y update\n","apt-get -y install openjdk-7-jdk maven git\n","apt-get -y remove openjdk-6-jre-lib  openjdk-6-jre openjdk-6-jre-headless\n","cd ~\n","git clone https://github.com/pdeyhim/aws-rum.git\n","cd ~/aws-rum\n","sed -i 's/dynamoDBKey.*/dynamoDBKey=",{"Ref":"DynamoDBKey"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/dynamoDBRangeKey.*/dynamoDBRangeKey=",{"Ref":"DynamoDBRangeKey"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/readCapacityUnits.*/readCapacityUnits=",{"Ref":"DynamoDBReadCapacityUnits"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/writeCapacityUnits.*/writeCapacityUnits=",{"Ref":"DynamoDBWriteCapacityUnits"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/bufferSizeByteLimit.*/bufferSizeByteLimit=",{"Ref":"DynamoDBBufferSizeLimit"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/bufferRecordCountLimit.*/bufferRecordCountLimit=",{"Ref":"DynamoDBBufferRecordLimit"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/dynamoDBDataTableName.*/dynamoDBDataTableName=",{"Ref":"DynamoDBTable"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","echo 'dataJsonSchemaS3Key=",{"Ref":"JsonSchemaKey"},"' >> /root/aws-rum/conf/DynamoDB.properties\n","echo 'dataJsonSchemaS3Bucket=",{"Ref":"JsonSchemaBucket"},"' >> /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/schemaVersion.*/schemaVersion=",{"Ref":"DataSchemaVersion"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","sed -i 's/kinesisInputStream.*/kinesisInputStream=",{"Ref":"KinesisStreamName"},"/g' /root/aws-rum/conf/DynamoDB.properties\n","./GenerateDataModel.sh DynamoDB.properties\n","./run.sh com.amazon.services.awsrum.ddb.DynamoDBExecutor&\n"]]}}}},"AWSRumSG":{"Type":"AWS::EC2::SecurityGroup","Properties":{"GroupDescription":"Allow access from load balancer and bastion as well as outbound HTTP and HTTPS traffic","VpcId":{"Ref":"VPC"},"SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":{"Ref":"SSHLocation"}},{"IpProtocol":"tcp","FromPort":"0","ToPort":"65535","CidrIp":"10.0.0.0/16"},{"IpProtocol":"tcp","FromPort":"50030","ToPort":"50030","CidrIp":{"Ref":"SSHLocation"}}]}},"DynamoDBCollectorServerScaleUpPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"DynamoDBCollectorASG"},"Cooldown":"60","ScalingAdjustment":"1"}},"DynamoDBCollectorServerScaleDownPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"DynamoDBCollectorASG"},"Cooldown":"60","ScalingAdjustment":"-1"}},"DynamoDBCollectorCPUAlarmHigh":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-up if CPU > 90% for 10 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"300","EvaluationPeriods":"2","Threshold":"90","AlarmActions":[{"Ref":"DynamoDBCollectorServerScaleUpPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"DynamoDBCollectorASG"}}],"ComparisonOperator":"GreaterThanThreshold"}},"DynamoDBCollectorCPUAlarmLow":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-down if CPU < 70% for 10 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"300","EvaluationPeriods":"2","Threshold":"70","AlarmActions":[{"Ref":"DynamoDBCollectorServerScaleDownPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"DynamoDBCollectorASG"}}],"ComparisonOperator":"LessThanThreshold"}},"DynamoDBCollectorRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/"}},"DynamoDBCollectorRolePolicies":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"root","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":"*","Resource":"*"}]},"Roles":[{"Ref":"DynamoDBCollectorRole"}]}},"DynamoDBCollectorInstanceProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"DynamoDBCollectorRole"}]}},"RedshiftCluster":{"Type":"AWS::Redshift::Cluster","Properties":{"VpcSecurityGroupIds":[{"Ref":"AWSRumSG"}],"MasterUserPassword":{"Ref":"RedshiftPassword"},"ClusterType":"single-node","MasterUsername":{"Ref":"RedshiftUsername"},"NodeType":{"Ref":"RedshiftNodeType"},"DBName":{"Ref":"RedshiftDatabaseName"},"ClusterSubnetGroupName":{"Ref":"RedshiftClusterSubnetGroup"}}},"DynamoDBTable":{"Type":"AWS::DynamoDB::Table","Properties":{"AttributeDefinitions":[{"AttributeName":{"Ref":"DynamoDBKey"},"AttributeType":"S"},{"AttributeName":{"Ref":"DynamoDBRangeKey"},"AttributeType":"N"}],"KeySchema":[{"KeyType":"HASH","AttributeName":{"Ref":"DynamoDBKey"}},{"AttributeName":{"Ref":"DynamoDBRangeKey"},"KeyType":"RANGE"}],"ProvisionedThroughput":{"ReadCapacityUnits":{"Ref":"DynamoDBReadCapacityUnits"},"WriteCapacityUnits":{"Ref":"DynamoDBWriteCapacityUnits"}}}},"RedshiftClusterSubnetGroup":{"Type":"AWS::Redshift::ClusterSubnetGroup","Properties":{"Description":"Redshift ClusterSubnetGroup","SubnetIds":[{"Ref":"PublicSubnet1"},{"Ref":"PublicSubnet2"}]}},"Public2SubnetRouteTableAssociation":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"PublicSubnet2"},"RouteTableId":{"Ref":"PublicRouteTable"}}},"RedshiftCollectorASG":{"Type":"AWS::AutoScaling::AutoScalingGroup","Properties":{"AvailabilityZones":[{"Fn::GetAtt":["PublicSubnet1","AvailabilityZone"]},{"Fn::GetAtt":["PublicSubnet2","AvailabilityZone"]},{"Fn::GetAtt":["PublicSubnet3","AvailabilityZone"]}],"VPCZoneIdentifier":[{"Ref":"PublicSubnet1"},{"Ref":"PublicSubnet2"},{"Ref":"PublicSubnet3"}],"LaunchConfigurationName":{"Ref":"RedshiftCollectorLaunchConfig"},"MinSize":"1","MaxSize":"10","DesiredCapacity":{"Ref":"RedshiftCollectorNumberOfNodes"},"Tags":[{"Key":"Network","Value":"Public","PropagateAtLaunch":"true"},{"Key":"Name","Value":"RedshiftCollector","PropagateAtLaunch":"true"}]},"UpdatePolicy":{"AutoScalingRollingUpdate":{"MinInstancesInService":"1","MaxBatchSize":"1"}}},"RedshiftCollectorLaunchConfig":{"Type":"AWS::AutoScaling::LaunchConfiguration","Properties":{"ImageId":{"Fn::FindInMap":["AWSRegionArch2AMI",{"Ref":"AWS::Region"},{"Fn::FindInMap":["AWSInstanceType2Arch",{"Ref":"RedshiftCollectorInstanceType"},"Arch"]}]},"SecurityGroups":[{"Ref":"AWSRumSG"}],"InstanceType":{"Ref":"RedshiftCollectorInstanceType"},"KeyName":{"Ref":"KeyName"},"AssociatePublicIpAddress":"true","IamInstanceProfile":{"Ref":"RedshiftCollectorInstanceProfile"},"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -ex\n","exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n","apt-get -y update\n","apt-get -y install openjdk-7-jdk maven git\n","apt-get -y remove openjdk-6-jre-lib  openjdk-6-jre openjdk-6-jre-headless\n","cd ~\n","git clone https://github.com/pdeyhim/aws-rum.git\n","cd ~/aws-rum\n","sed -i 's/s3Bucket.*/s3Bucket=",{"Ref":"RedshiftS3Bucket"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/bufferSizeByteLimit.*/bufferSizeByteLimit=",{"Ref":"RedshiftBufferSizeLimit"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/bufferRecordCountLimit.*/bufferRecordCountLimit=",{"Ref":"RedshiftBufferRecordLimit"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftDataTable.*/redshiftDataTable=",{"Ref":"RedshiftTable"},"_",{"Ref":"DataSchemaVersion"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftUsername.*/redshiftUsername=",{"Ref":"RedshiftUsername"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftPassword.*/redshiftPassword=",{"Ref":"RedshiftPassword"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftURL.*/redshiftURL=",{"Fn::Join":["",["jdbc:postgresql:\\/\\/",{"Fn::GetAtt":["RedshiftCluster","Endpoint.Address"]},"\\:",{"Fn::GetAtt":["RedshiftCluster","Endpoint.Port"]},"\\/",{"Ref":"RedshiftDatabaseName"}]]},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftDataDelimiter.*/redshiftDataDelimiter=",{"Ref":"RedshiftDataDelimiter"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftClusterIdentifier.*/redshiftClusterIdentifier=",{"Ref":"RedshiftClusterName"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftDatabaseName.*/redshiftDatabaseName=",{"Ref":"RedshiftDatabaseName"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftClusterType.*/redshiftClusterType=",{"Ref":"RedshiftNodeType"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/redshiftNumberOfNodes.*/redshiftNumberOfNodes=",{"Ref":"RedshiftNumberOfNodes"},"/g' /root/aws-rum/conf/Redshift.properties\n","echo 'redshiftCopyAccesskey=",{"Ref":"RedshiftS3StagingBucketS3UserKeys"},"' >> /root/aws-rum/conf/Redshift.properties\n","echo 'redshiftCopyAccessSecretKey=",{"Fn::GetAtt":["RedshiftS3StagingBucketS3UserKeys","SecretAccessKey"]},"' >>/root/aws-rum/conf/Redshift.properties\n","printf \"\\n\"\n","sed -i 's/schemaVersion.*/schemaVersion=",{"Ref":"DataSchemaVersion"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/kinesisInputStream.*/kinesisInputStream=",{"Ref":"KinesisStreamName"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/dataJsonSchemaS3Bucket.*/dataJsonSchemaS3Bucket=",{"Ref":"JsonSchemaBucket"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/dataJsonSchemaS3Key.*/dataJsonSchemaS3Key=",{"Ref":"JsonSchemaKey"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/dynamoDBKey.*/dynamoDBKey=",{"Ref":"DynamoDBKey"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/dynamoDBRangeKey.*/dynamoDBRangeKey=",{"Ref":"DynamoDBRangeKey"},"/g' /root/aws-rum/conf/Redshift.properties\n","sed -i 's/dynamoDBDataTableName.*/dynamoDBDataTableName=",{"Ref":"DynamoDBTable"},"/g' /root/aws-rum/conf/Redshift.properties\n","sleep 400\n","./GenerateDataModel.sh Redshift.properties\n","./run.sh com.amazon.services.awsrum.redshift.RedshiftBasicExecutor&\n"]]}}}},"RedshiftCollectorRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/"}},"RedshiftCollectorRolePolicies":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"root","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":"*","Resource":"*"}]},"Roles":[{"Ref":"RedshiftCollectorRole"}]}},"RedshiftCollectorInstanceProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"RedshiftCollectorRole"}]}},"RedshiftCollectorServerScaleUpPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"RedshiftCollectorASG"},"Cooldown":"60","ScalingAdjustment":"1"}},"RedshiftCollectorServerScaleDownPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"RedshiftCollectorASG"},"Cooldown":"60","ScalingAdjustment":"-1"}},"RedshiftCollectorCPUAlarmHigh":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-up if CPU > 90% for 10 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"300","EvaluationPeriods":"2","Threshold":"90","AlarmActions":[{"Ref":"DynamoDBCollectorServerScaleUpPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"RedshiftCollectorASG"}}],"ComparisonOperator":"GreaterThanThreshold"}},"RedshiftCollectorCPUAlarmLow":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-down if CPU < 70% for 10 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"300","EvaluationPeriods":"2","Threshold":"70","AlarmActions":[{"Ref":"DynamoDBCollectorServerScaleDownPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"RedshiftCollectorASG"}}],"ComparisonOperator":"LessThanThreshold"}},"RedshiftS3StagingBucket":{"Type":"AWS::S3::Bucket","Properties":{"BucketName":{"Ref":"RedshiftS3Bucket"}}},"RedshiftS3StagingBucketS3User":{"Type":"AWS::IAM::User"},"RedshiftS3StagingBucketS3UserKeys":{"Type":"AWS::IAM::AccessKey","Properties":{"UserName":{"Ref":"RedshiftS3StagingBucketS3User"}}},"RedshiftS3StagingBucketUserPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"S3FullAccess","PolicyDocument":{"Version":"2008-10-17","Statement":[{"Resource":[{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"RedshiftS3Bucket"},"/*"]]},{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"RedshiftS3Bucket"}]]}],"Sid":"FullAccess","Action":["s3:*"],"Effect":"Allow"}]},"Users":[{"Ref":"RedshiftS3StagingBucketS3User"}]}}}}